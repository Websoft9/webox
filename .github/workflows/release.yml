name: ğŸ‰ Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: '1.24.5'
  REGISTRY: docker.io
  REGISTRY_NAMESPACE: websoft9

jobs:
  # éªŒè¯å‘å¸ƒæ¡ä»¶
  validate-release:
    name: ğŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      is_prerelease: ${{ steps.check-prerelease.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ inputs.version }}"
          else
            version="${{ github.ref_name }}"
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $version"

          # éªŒè¯ç‰ˆæœ¬æ ¼å¼
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®: $version"
            echo "æ­£ç¡®æ ¼å¼: v1.0.0 æˆ– v1.0.0-alpha"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬æ ¼å¼æ­£ç¡®"

      - name: Check if pre-release
        id: check-prerelease
        run: |
          version="${{ steps.extract-version.outputs.version }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            is_prerelease="${{ inputs.prerelease }}"
          else
            # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦åŒ…å«é¢„å‘å¸ƒæ ‡è¯†
            if [[ "$version" =~ -[a-zA-Z] ]]; then
              is_prerelease="true"
            else
              is_prerelease="false"
            fi
          fi

          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT
          echo "æ˜¯å¦é¢„å‘å¸ƒ: $is_prerelease"

      - name: Validate changelog
        run: |
          version="${{ steps.extract-version.outputs.version }}"

          if [ -f "CHANGELOG.md" ]; then
            if grep -q "$version" CHANGELOG.md; then
              echo "âœ… CHANGELOG.md åŒ…å«ç‰ˆæœ¬ $version"
            else
              echo "âš ï¸ CHANGELOG.md ä¸åŒ…å«ç‰ˆæœ¬ $version"
              echo "å»ºè®®åœ¨ CHANGELOG.md ä¸­æ·»åŠ ç‰ˆæœ¬è¯´æ˜"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° CHANGELOG.md æ–‡ä»¶"
            echo "å»ºè®®åˆ›å»º CHANGELOG.md æ–‡ä»¶è®°å½•ç‰ˆæœ¬å˜æ›´"
          fi

      - name: Check for breaking changes
        run: |
          version="${{ steps.extract-version.outputs.version }}"

          # æ£€æŸ¥æ˜¯å¦ä¸ºä¸»ç‰ˆæœ¬æ›´æ–°ï¼ˆå¯èƒ½åŒ…å«ç ´åæ€§å˜æ›´ï¼‰
          if [[ "$version" =~ ^v[0-9]+\.0\.0$ ]]; then
            echo "âš ï¸ ä¸»ç‰ˆæœ¬æ›´æ–°ï¼Œå¯èƒ½åŒ…å«ç ´åæ€§å˜æ›´"
            echo "è¯·ç¡®ä¿å·²æ›´æ–°è¿ç§»æŒ‡å—å’Œæ–‡æ¡£"
          fi

  # è¿è¡Œå‘å¸ƒå‰æµ‹è¯•
  pre-release-tests:
    name: ğŸ§ª Pre-release Tests
    runs-on: ubuntu-latest
    needs: [validate-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Run comprehensive tests
        run: |
          echo "è¿è¡Œå‘å¸ƒå‰æµ‹è¯•..."

          # è¿è¡Œ api-service æµ‹è¯•
          cd webox/api-service
          mkdir -p reports
          go test -v -race -coverprofile=reports/coverage.out ./...
          cd ../..

          # è¿è¡Œ websoft9-agent æµ‹è¯•
          cd webox/websoft9-agent
          mkdir -p reports
          go test -v -race -coverprofile=reports/coverage.out ./...
          cd ../..

          echo "âœ… å‘å¸ƒå‰æµ‹è¯•å®Œæˆ"

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: pre-release-test-reports
          path: |
            webox/api-service/reports/
            webox/websoft9-agent/reports/
          retention-days: 30

  # æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
  build-binaries:
    name: ğŸ”¨ Build Multi-platform Binaries
    runs-on: ubuntu-latest
    needs: [validate-release, pre-release-tests]
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
        include:
          - service: api-service
            context: webox/api-service
            main_path: ./cmd/server
          - service: websoft9-agent
            context: webox/websoft9-agent
            main_path: ./cmd/agent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.context }}/go.sum

      - name: Build multi-platform binaries
        run: |
          version="${{ needs.validate-release.outputs.version }}"
          service="${{ matrix.service }}"
          context="${{ matrix.context }}"
          main_path="${{ matrix.main_path }}"

          echo "æ„å»º $service å¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶..."

          cd "$context"

          # å®šä¹‰æ„å»ºç›®æ ‡
          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          mkdir -p ../../dist/$service

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"

            echo "æ„å»º $GOOS/$GOARCH..."

            output_name="$service"
            if [ "$GOOS" = "windows" ]; then
              output_name="$service.exe"
            fi

            output_path="../../dist/$service/${service}_${version}_${GOOS}_${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output_path="${output_path}.exe"
            fi

            # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags "-X main.Version=$version -X main.Commit=${{ github.sha }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              -o "$output_path" \
              "$main_path"

            # ç”Ÿæˆæ ¡éªŒå’Œ
            if [ "$GOOS" = "windows" ]; then
              sha256sum "$output_path" > "${output_path}.sha256"
            else
              shasum -a 256 "$output_path" > "${output_path}.sha256"
            fi

            echo "âœ… $GOOS/$GOARCH æ„å»ºå®Œæˆ"
          done

          echo "âœ… $service å¤šå¹³å°æ„å»ºå®Œæˆ"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-binaries
          path: dist/${{ matrix.service }}/
          retention-days: 30

  # æ„å»ºå’Œæ¨é€ Docker é•œåƒ
  build-docker-images:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [validate-release, pre-release-tests]
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
        include:
          - service: api-service
            dockerfile: webox/api-service/Dockerfile
            context: webox/api-service
          - service: websoft9-agent
            dockerfile: webox/websoft9-agent/Dockerfile
            context: webox/websoft9-agent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate-release.outputs.version }}
            COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.service }}:${{ needs.validate-release.outputs.version }}
          format: spdx-json
          output-file: ${{ matrix.service }}-sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-sbom
          path: ${{ matrix.service }}-sbom.spdx.json
          retention-days: 90

  # ç”Ÿæˆå‘å¸ƒè¯´æ˜
  generate-release-notes:
    name: ğŸ“ Generate Release Notes
    runs-on: ubuntu-latest
    needs: [validate-release]
    outputs:
      release_notes: ${{ steps.generate-notes.outputs.release_notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: generate-notes
        run: |
          version="${{ needs.validate-release.outputs.version }}"

          echo "ç”Ÿæˆå‘å¸ƒè¯´æ˜..."

          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$previous_tag" ]; then
            echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $previous_tag"
            commit_range="$previous_tag..HEAD"
          else
            echo "é¦–æ¬¡å‘å¸ƒ"
            commit_range="HEAD"
          fi

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat > release_notes.md << EOF
          # $version å‘å¸ƒè¯´æ˜

          **å‘å¸ƒæ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **æäº¤èŒƒå›´:** $commit_range

          ## ğŸ‰ æ–°åŠŸèƒ½

          EOF

          # æå–æ–°åŠŸèƒ½æäº¤
          git log --pretty=format:"- %s (%h)" $commit_range --grep="^feat" >> release_notes.md || true

          cat >> release_notes.md << EOF

          ## ğŸ› Bug ä¿®å¤

          EOF

          # æå– bug ä¿®å¤æäº¤
          git log --pretty=format:"- %s (%h)" $commit_range --grep="^fix" >> release_notes.md || true

          cat >> release_notes.md << EOF

          ## ğŸ“š æ–‡æ¡£æ›´æ–°

          EOF

          # æå–æ–‡æ¡£æ›´æ–°æäº¤
          git log --pretty=format:"- %s (%h)" $commit_range --grep="^docs" >> release_notes.md || true

          cat >> release_notes.md << EOF

          ## ğŸ”§ å…¶ä»–å˜æ›´

          EOF

          # æå–å…¶ä»–ç±»å‹çš„æäº¤
          git log --pretty=format:"- %s (%h)" $commit_range --grep="^refactor\|^perf\|^test\|^chore" >> release_notes.md || true

          cat >> release_notes.md << EOF

          ## ğŸ“¦ ä¸‹è½½

          ### Docker é•œåƒ

          \`\`\`bash
          # API Service
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/api-service:$version

          # Websoft9 Agent
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/websoft9-agent:$version
          \`\`\`

          ### äºŒè¿›åˆ¶æ–‡ä»¶

          è¯·ä» [Releases é¡µé¢](https://github.com/${{ github.repository }}/releases/tag/$version) ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

          ## ğŸ” æ ¡éªŒå’Œ

          æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æä¾›äº† SHA256 æ ¡éªŒå’Œï¼Œè¯·åœ¨ä½¿ç”¨å‰éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚

          ## ğŸ“‹ å®Œæ•´å˜æ›´æ—¥å¿—

          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/$version/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ä¿¡æ¯ã€‚

          ## ğŸ†˜ æ”¯æŒ

          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

          1. æŸ¥çœ‹ [æ–‡æ¡£](https://docs.websoft9.com)
          2. æœç´¢ [å·²çŸ¥é—®é¢˜](https://github.com/${{ github.repository }}/issues)
          3. åˆ›å»º [æ–°çš„ Issue](https://github.com/${{ github.repository }}/issues/new)

          ---

          **å®Œæ•´æäº¤å†å²:**

          EOF

          # æ·»åŠ å®Œæ•´çš„æäº¤å†å²
          git log --pretty=format:"- %s (%h) by %an" $commit_range >> release_notes.md

          # è¾“å‡ºå‘å¸ƒè¯´æ˜
          release_notes=$(cat release_notes.md)
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$release_notes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "âœ… å‘å¸ƒè¯´æ˜ç”Ÿæˆå®Œæˆ"

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.md
          retention-days: 90

  # åˆ›å»º GitHub Release
  create-github-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-binaries, build-docker-images, generate-release-notes]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release assets
        run: |
          echo "å‡†å¤‡å‘å¸ƒèµ„äº§..."

          mkdir -p release-assets

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp -r api-service-binaries/* release-assets/ 2>/dev/null || true
          cp -r websoft9-agent-binaries/* release-assets/ 2>/dev/null || true

          # å¤åˆ¶ SBOM æ–‡ä»¶
          cp -r *-sbom/* release-assets/ 2>/dev/null || true

          # ç”Ÿæˆå‘å¸ƒèµ„äº§æ¸…å•
          echo "# å‘å¸ƒèµ„äº§æ¸…å•" > release-assets/ASSETS.md
          echo "" >> release-assets/ASSETS.md
          echo "## äºŒè¿›åˆ¶æ–‡ä»¶" >> release-assets/ASSETS.md
          echo "" >> release-assets/ASSETS.md

          for file in release-assets/*; do
            if [[ -f "$file" && ! "$file" =~ \.(md|json)$ ]]; then
              filename=$(basename "$file")
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "- **$filename** ($size)" >> release-assets/ASSETS.md
            fi
          done

          echo "" >> release-assets/ASSETS.md
          echo "## è½¯ä»¶ç‰©æ–™æ¸…å• (SBOM)" >> release-assets/ASSETS.md
          echo "" >> release-assets/ASSETS.md

          for file in release-assets/*.spdx.json; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              echo "- **$filename**" >> release-assets/ASSETS.md
            fi
          done

          echo "âœ… å‘å¸ƒèµ„äº§å‡†å¤‡å®Œæˆ"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          release_name: ${{ needs.validate-release.outputs.version }}
          body: ${{ needs.generate-release-notes.outputs.release_notes }}
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is_prerelease }}

      - name: Upload release assets
        run: |
          echo "ä¸Šä¼ å‘å¸ƒèµ„äº§..."

          upload_url="${{ steps.create_release.outputs.upload_url }}"

          for file in release-assets/*; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              echo "ä¸Šä¼  $filename..."

              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$file" \
                "${upload_url%\{*}?name=$filename"
            fi
          done

          echo "âœ… å‘å¸ƒèµ„äº§ä¸Šä¼ å®Œæˆ"



  # å‘å¸ƒæ€»ç»“
  release-summary:
    name: ğŸ“Š Release Summary
    runs-on: ubuntu-latest
    needs: [validate-release, pre-release-tests, build-binaries, build-docker-images, create-github-release]
    if: always()
    steps:
      - name: Generate release summary
        run: |
          version="${{ needs.validate-release.outputs.version }}"
          is_prerelease="${{ needs.validate-release.outputs.is_prerelease }}"

          echo "# ğŸ‰ å‘å¸ƒæ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** $version" >> $GITHUB_STEP_SUMMARY
          echo "**ç±»å‹:** $([ "$is_prerelease" = "true" ] && echo "é¢„å‘å¸ƒ" || echo "æ­£å¼å‘å¸ƒ")" >> $GITHUB_STEP_SUMMARY
          echo "**å‘å¸ƒè€…:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“‹ æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å‘å¸ƒéªŒè¯ | ${{ needs.validate-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å‘å¸ƒå‰æµ‹è¯• | ${{ needs.pre-release-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| äºŒè¿›åˆ¶æ„å»º | ${{ needs.build-binaries.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker æ„å»º | ${{ needs.build-docker-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub å‘å¸ƒ | ${{ needs.create-github-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ç¡®å®šæ•´ä½“çŠ¶æ€
          if [[ "${{ needs.create-github-release.result }}" == "success" ]]; then
            echo "## âœ… å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ç‰ˆæœ¬ $version å·²æˆåŠŸå‘å¸ƒï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ å‘å¸ƒå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/$version)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/${{ env.REGISTRY_NAMESPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY