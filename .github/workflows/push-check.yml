name: ğŸš€ Push Check

on:
  push:
    branches: [ main, develop, 'bugfix/**', 'hotfix/**' ]

env:
  GO_VERSION: '1.24.5'

jobs:
  # æäº¤æ¶ˆæ¯æ ¼å¼æ£€æŸ¥
  commit-message-check:
    name: ğŸ“ Commit Message Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check latest commit message
        run: |
          echo "æ£€æŸ¥æœ€æ–°æäº¤æ¶ˆæ¯æ ¼å¼..."

          # è·å–æœ€æ–°æäº¤æ¶ˆæ¯
          message=$(git log --format=%s -n 1 HEAD)
          echo "æäº¤æ¶ˆæ¯: $message"

          # æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼
          if ! ./scripts/check-commit-message.sh "$message"; then
            echo "âŒ æäº¤æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®"
            echo ""
            echo "è¯·ä¿®æ”¹æäº¤æ¶ˆæ¯ä»¥ç¬¦åˆ Conventional Commits è§„èŒƒ:"
            echo "æ ¼å¼: <type>[optional scope]: <description>"
            echo "ç¤ºä¾‹: feat(auth): add JWT token refresh mechanism"
            exit 1
          fi

          echo "âœ… æäº¤æ¶ˆæ¯æ ¼å¼æ­£ç¡®"

  # ä»£ç æ ¼å¼æ£€æŸ¥
  code-format-check:
    name: ğŸ¨ Code Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Check Go formatting
        run: |
          echo "æ£€æŸ¥ Go ä»£ç æ ¼å¼..."

          # æ£€æŸ¥ api-service
          if [ -d "webox/api-service" ]; then
            cd webox/api-service
            unformatted=$(gofmt -l .)
            if [ -n "$unformatted" ]; then
              echo "âŒ api-service ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®:"
              echo "$unformatted"
              exit 1
            fi
            cd ../..
          fi

          # æ£€æŸ¥ websoft9-agent
          if [ -d "webox/websoft9-agent" ]; then
            cd webox/websoft9-agent
            unformatted=$(gofmt -l .)
            if [ -n "$unformatted" ]; then
              echo "âŒ websoft9-agent ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®:"
              echo "$unformatted"
              exit 1
            fi
            cd ../..
          fi

          echo "âœ… Go ä»£ç æ ¼å¼æ­£ç¡®"

      - name: Run golangci-lint for api-service
        if: hashFiles('webox/api-service/go.mod') != ''
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: webox/api-service
          args: --timeout=5m

      - name: Run golangci-lint for websoft9-agent
        if: hashFiles('webox/websoft9-agent/go.mod') != ''
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: webox/websoft9-agent
          args: --timeout=5m

  # å¿«é€Ÿæ„å»ºæ£€æŸ¥
  build-check:
    name: ğŸ”¨ Build Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build ${{ matrix.service }}
        run: |
          # æ‰“å°å½“å‰ç›®å½•è·¯å¾„
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la

          if [ ! -d "webox/${{ matrix.service }}" ]; then
            echo "â­ï¸ è·³è¿‡ ${{ matrix.service }}ï¼Œç›®å½•ä¸å­˜åœ¨"
            exit 0
          fi

          echo "æ„å»º ${{ matrix.service }}..."
          cd webox/${{ matrix.service }}
          echo "åˆ‡æ¢åˆ°ç›®å½•: $(pwd)"

          # ä¸‹è½½ä¾èµ–
          go mod download

          # æ„å»º
          if [ -f "Makefile" ]; then
            make build
          else
            go build -v ./...
          fi

          echo "âœ… ${{ matrix.service }} æ„å»ºæˆåŠŸ"

  # å¿«é€Ÿæµ‹è¯•
  quick-test:
    name: âš¡ Quick Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Run quick tests for api-service
        if: hashFiles('webox/api-service/go.mod') != ''
        working-directory: webox/api-service
        run: |
          echo "è¿è¡Œ api-service å¿«é€Ÿæµ‹è¯•..."
          go test -short -race ./...

      - name: Run quick tests for websoft9-agent
        if: hashFiles('webox/websoft9-agent/go.mod') != ''
        working-directory: webox/websoft9-agent
        run: |
          echo "è¿è¡Œ websoft9-agent å¿«é€Ÿæµ‹è¯•..."
          go test -short -race ./...

  # æ¨é€æ£€æŸ¥æ±‡æ€»
  push-check-summary:
    name: ğŸ“Š Push Check Summary
    runs-on: ubuntu-latest
    needs: [commit-message-check, code-format-check, build-check, quick-test]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "=== æ¨é€æ£€æŸ¥ç»“æœæ±‡æ€» ==="

          # æ£€æŸ¥å„ä¸ªä½œä¸šçš„çŠ¶æ€
          commit_check="${{ needs.commit-message-check.result }}"
          code_format="${{ needs.code-format-check.result }}"
          build_check="${{ needs.build-check.result }}"
          quick_test="${{ needs.quick-test.result }}"

          echo "æäº¤æ¶ˆæ¯æ£€æŸ¥: $commit_check"
          echo "ä»£ç æ ¼å¼æ£€æŸ¥: $code_format"
          echo "æ„å»ºæ£€æŸ¥: $build_check"
          echo "å¿«é€Ÿæµ‹è¯•: $quick_test"

          # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„ä½œä¸š
          failed_jobs=()

          [ "$commit_check" = "failure" ] && failed_jobs+=("æäº¤æ¶ˆæ¯æ£€æŸ¥")
          [ "$code_format" = "failure" ] && failed_jobs+=("ä»£ç æ ¼å¼æ£€æŸ¥")
          [ "$build_check" = "failure" ] && failed_jobs+=("æ„å»ºæ£€æŸ¥")
          [ "$quick_test" = "failure" ] && failed_jobs+=("å¿«é€Ÿæµ‹è¯•")

          if [ ${#failed_jobs[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ä»¥ä¸‹æ£€æŸ¥å¤±è´¥:"
            for job in "${failed_jobs[@]}"; do
              echo "  - $job"
            done
            echo ""
            echo "è¯·ä¿®å¤å¤±è´¥çš„æ£€æŸ¥é¡¹"
            exit 1
          fi

          echo ""
          echo "âœ… æ‰€æœ‰æ¨é€æ£€æŸ¥é€šè¿‡ï¼"