name: ðŸ”’ Security Scan

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: "0 2 * * *"
  push:
    branches: [main]
    paths:
      - "go.mod"
      - "go.sum"
      - "**/go.mod"
      - "**/go.sum"
  workflow_dispatch:

env:
  GO_VERSION: "1.24.5"

jobs:
  # ä¾èµ–æ¼æ´žæ‰«æ
  dependency-scan:
    name: ðŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            api-service/go.sum
            websoft9-agent/go.sum

      - name: Install govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run vulnerability scan for api-service
        run: |
          echo "æ‰«æ api-service ä¾èµ–æ¼æ´ž..."
          cd api-service
          govulncheck ./... || true
          cd ..

      - name: Run vulnerability scan for websoft9-agent
        run: |
          echo "æ‰«æ websoft9-agent ä¾èµ–æ¼æ´ž..."
          cd websoft9-agent
          govulncheck ./... || true
          cd ..

  # ä»£ç å®‰å…¨æ‰«æ
  code-security-scan:
    name: ðŸ” Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            api-service/go.sum
            websoft9-agent/go.sum

      - name: Install Gosec
        run: |
          echo "å®‰è£… Gosec å®‰å…¨æ‰«æå·¥å…·..."
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run Gosec Security Scanner for api-service
        run: |
          echo "è¿è¡Œ api-service å®‰å…¨æ‰«æ..."

          if [ ! -d "api-service" ]; then
            echo "â­ï¸ è·³è¿‡ api-serviceï¼Œç›®å½•ä¸å­˜åœ¨"
          else
            cd api-service
            mkdir -p reports

            echo "æ‰«æ api-service Go ä»£ç ..."
            # ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            config_flag=""
            if [ -f "../.gosec.json" ]; then
              config_flag="-conf ../.gosec.json"
            fi

            if gosec $config_flag -fmt sarif -out reports/gosec-results.sarif ./... 2>/dev/null; then
              echo "âœ… api-service SARIF æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
            else
              echo "âš ï¸ api-service SARIF æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œå°è¯•åŸºæœ¬æ‰«æ"
              gosec $config_flag ./... || echo "âš ï¸ api-service å®‰å…¨æ‰«æå®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"
            fi

            # ç”Ÿæˆ JSON æŠ¥å‘Šï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
            gosec $config_flag -fmt json -out reports/gosec-results.json ./... 2>/dev/null || true
            cd ../..
          fi

      - name: Run Gosec Security Scanner for websoft9-agent
        run: |
          echo "è¿è¡Œ websoft9-agent å®‰å…¨æ‰«æ..."

          if [ ! -d "websoft9-agent" ]; then
            echo "â­ï¸ è·³è¿‡ websoft9-agentï¼Œç›®å½•ä¸å­˜åœ¨"
          else
            cd websoft9-agent
            mkdir -p reports

            echo "æ‰«æ websoft9-agent Go ä»£ç ..."
            # ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            config_flag=""
            if [ -f "../.gosec.json" ]; then
              config_flag="-conf ../.gosec.json"
            fi

            if gosec $config_flag -fmt sarif -out reports/gosec-results.sarif ./... 2>/dev/null; then
              echo "âœ… websoft9-agent SARIF æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
            else
              echo "âš ï¸ websoft9-agent SARIF æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œå°è¯•åŸºæœ¬æ‰«æ"
              gosec $config_flag ./... || echo "âš ï¸ websoft9-agent å®‰å…¨æ‰«æå®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"
            fi

            # ç”Ÿæˆ JSON æŠ¥å‘Šï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
            gosec $config_flag -fmt json -out reports/gosec-results.json ./... 2>/dev/null || true
            cd ../..
          fi

      - name: Upload Gosec scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gosec-security-reports
          path: |
            api-service/reports/gosec-*
            websoft9-agent/reports/gosec-*
          retention-days: 30

      - name: Upload Gosec scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('api-service/reports/gosec-results.sarif') != ''
        with:
          sarif_file: api-service/reports/gosec-results.sarif
          category: api-service-gosec

      - name: Upload Agent Gosec scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('websoft9-agent/reports/gosec-results.sarif') != ''
        with:
          sarif_file: websoft9-agent/reports/gosec-results.sarif
          category: websoft9-agent-gosec

  # å®‰å…¨æ‰«ææ±‡æ€»
  security-summary:
    name: ðŸ“Š Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "# ðŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Šæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«ææ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“‹ æ‰«æç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰«æç±»åž‹ | çŠ¶æ€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾èµ–æ¼æ´žæ‰«æ | ${{ needs.dependency-scan.result }} | ä½¿ç”¨ govulncheck æ£€æŸ¥ Go ä¾èµ–åŒ…æ¼æ´ž |" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç å®‰å…¨æ‰«æ | ${{ needs.code-security-scan.result }} | ä½¿ç”¨ Gosec è¿›è¡Œé™æ€ä»£ç å®‰å…¨åˆ†æž |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ç¡®å®šæ•´ä½“å®‰å…¨çŠ¶æ€
          if [[ "${{ needs.dependency-scan.result }}" == "failure" || "${{ needs.code-security-scan.result }}" == "failure" ]]; then
            echo "## âŒ å‘çŽ°å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å®‰å…¨æ‰«æå‘çŽ°äº†éœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶åŠæ—¶ä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… å®‰å…¨æ‰«æé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å®‰å…¨æ‰«æéƒ½å·²é€šè¿‡ï¼Œæœªå‘çŽ°ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Ž ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Security æ ‡ç­¾é¡µ](${{ github.server_url }}/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
