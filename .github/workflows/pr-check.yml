name: ğŸ” PR Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, edited ]

env:
  GO_VERSION: '1.24.5'
  COVERAGE_THRESHOLD: 80

jobs:
  # æäº¤æ¶ˆæ¯æ ¼å¼æ£€æŸ¥
  commit-message-check:
    name: ğŸ“ Commit Message Check
    runs-on: ubuntu-latest
    if: github.event.action != 'edited'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼..."
          
          # è·å– PR ä¸­çš„æ‰€æœ‰æäº¤
          commits=$(git rev-list --reverse ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          failed_commits=()
          
          for commit in $commits; do
            message=$(git log --format=%s -n 1 $commit)
            echo "æ£€æŸ¥æäº¤: $commit"
            echo "æ¶ˆæ¯: $message"
            
            if ! ./scripts/check-commit-message.sh "$message"; then
              failed_commits+=("$commit: $message")
            fi
          done
          
          if [ ${#failed_commits[@]} -gt 0 ]; then
            echo "âŒ ä»¥ä¸‹æäº¤æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®:"
            for failed in "${failed_commits[@]}"; do
              echo "  - $failed"
            done
            echo ""
            echo "è¯·ä¿®æ”¹æäº¤æ¶ˆæ¯ä»¥ç¬¦åˆ Conventional Commits è§„èŒƒ:"
            echo "æ ¼å¼: <type>[optional scope]: <description>"
            echo "ç¤ºä¾‹: feat(auth): add JWT token refresh mechanism"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰æäº¤æ¶ˆæ¯æ ¼å¼æ­£ç¡®"

  # PR æ ‡é¢˜å’Œæè¿°æ£€æŸ¥
  pr-format-check:
    name: ğŸ“‹ PR Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        run: |
          title="${{ github.event.pull_request.title }}"
          echo "æ£€æŸ¥ PR æ ‡é¢˜: $title"
          
          # æ£€æŸ¥ PR æ ‡é¢˜æ˜¯å¦ç¬¦åˆ Conventional Commits æ ¼å¼
          if [[ ! "$title" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci)(\([a-zA-Z0-9_-]+\))?: .{1,50}$ ]]; then
            echo "âŒ PR æ ‡é¢˜æ ¼å¼ä¸æ­£ç¡®"
            echo "æ­£ç¡®æ ¼å¼: <type>[optional scope]: <description>"
            echo "ç¤ºä¾‹: feat(auth): add JWT token refresh mechanism"
            exit 1
          fi
          
          echo "âœ… PR æ ‡é¢˜æ ¼å¼æ­£ç¡®"

      - name: Check PR description
        run: |
          description="${{ github.event.pull_request.body }}"
          
          if [ -z "$description" ] || [ "$description" = "null" ]; then
            echo "âŒ PR æè¿°ä¸èƒ½ä¸ºç©º"
            echo "è¯·æ·»åŠ  PR æè¿°ï¼Œè¯´æ˜å˜æ›´å†…å®¹å’Œæµ‹è¯•æƒ…å†µ"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ä¿¡æ¯
          required_sections=("å˜æ›´ç±»å‹" "å˜æ›´æè¿°" "æµ‹è¯•è¯´æ˜")
          missing_sections=()
          
          for section in "${required_sections[@]}"; do
            if [[ ! "$description" =~ $section ]]; then
              missing_sections+=("$section")
            fi
          done
          
          if [ ${#missing_sections[@]} -gt 0 ]; then
            echo "âš ï¸ PR æè¿°ç¼ºå°‘ä»¥ä¸‹éƒ¨åˆ†:"
            for section in "${missing_sections[@]}"; do
              echo "  - $section"
            done
            echo ""
            echo "å»ºè®®ä½¿ç”¨ PR æ¨¡æ¿å¡«å†™å®Œæ•´ä¿¡æ¯"
          fi
          
          echo "âœ… PR æè¿°æ£€æŸ¥å®Œæˆ"

  # ä»£ç æ ¼å¼æ£€æŸ¥
  code-format-check:
    name: ğŸ¨ Code Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Check Go formatting
        run: |
          echo "æ£€æŸ¥ Go ä»£ç æ ¼å¼..."
          
          # æ£€æŸ¥ api-service
          cd webox/api-service
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "âŒ api-service ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®:"
            echo "$unformatted"
            exit 1
          fi
          
          # æ£€æŸ¥ websoft9-agent
          cd ../websoft9-agent
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "âŒ websoft9-agent ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®:"
            echo "$unformatted"
            exit 1
          fi
          
          echo "âœ… Go ä»£ç æ ¼å¼æ­£ç¡®"

      - name: Run golangci-lint for api-service
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: webox/api-service
          args: --timeout=5m --out-format=github-actions

      - name: Run golangci-lint for websoft9-agent
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: webox/websoft9-agent
          args: --timeout=5m --out-format=github-actions

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.23', '1.24.5']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Run unit tests for api-service
        working-directory: webox/api-service
        run: |
          echo "è¿è¡Œ api-service å•å…ƒæµ‹è¯•..."
          mkdir -p reports
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          go test -v -race -coverprofile=reports/coverage.out -covermode=atomic ./... | tee reports/test-results.txt
          
          # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          if [ -f "reports/coverage.out" ]; then
            go tool cover -html=reports/coverage.out -o reports/coverage.html
            go tool cover -func=reports/coverage.out > reports/coverage.txt
            
            # è®¡ç®—æ€»è¦†ç›–ç‡
            total_coverage=$(go tool cover -func=reports/coverage.out | grep "total:" | awk '{print $3}' | sed 's/%//' || echo "0")
            echo "API Service æ€»è¦†ç›–ç‡: ${total_coverage}%"
            echo "api_coverage=$total_coverage" >> $GITHUB_ENV
          fi

      - name: Run unit tests for websoft9-agent
        working-directory: webox/websoft9-agent
        run: |
          echo "è¿è¡Œ websoft9-agent å•å…ƒæµ‹è¯•..."
          mkdir -p reports
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          go test -v -race -coverprofile=reports/coverage.out -covermode=atomic ./... | tee reports/test-results.txt
          
          # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          if [ -f "reports/coverage.out" ]; then
            go tool cover -html=reports/coverage.out -o reports/coverage.html
            go tool cover -func=reports/coverage.out > reports/coverage.txt
            
            # è®¡ç®—æ€»è¦†ç›–ç‡
            total_coverage=$(go tool cover -func=reports/coverage.out | grep "total:" | awk '{print $3}' | sed 's/%//' || echo "0")
            echo "Agent æ€»è¦†ç›–ç‡: ${total_coverage}%"
            echo "agent_coverage=$total_coverage" >> $GITHUB_ENV
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-go${{ matrix.go-version }}
          path: |
            webox/api-service/reports/
            webox/websoft9-agent/reports/
          retention-days: 30

      - name: Comment coverage on PR
        if: matrix.go-version == '1.24.5'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = process.env.total_coverage;
            const threshold = process.env.COVERAGE_THRESHOLD;
            const isWarning = process.env.coverage_warning === 'true';
            
            let coverageIcon = 'âœ…';
            let coverageColor = 'green';
            
            if (isWarning) {
              coverageIcon = 'âš ï¸';
              coverageColor = 'orange';
            }
            
            const comment = `## ${coverageIcon} æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
            
            **æ€»è¦†ç›–ç‡:** ${coverage}% (é˜ˆå€¼: ${threshold}%)
            
            ${isWarning ? 'âš ï¸ **è­¦å‘Š:** è¦†ç›–ç‡ä½äºé˜ˆå€¼ï¼Œå»ºè®®å¢åŠ æµ‹è¯•ç”¨ä¾‹' : 'âœ… è¦†ç›–ç‡è¾¾åˆ°è¦æ±‚'}
            
            <details>
            <summary>è¯¦ç»†è¦†ç›–ç‡ä¿¡æ¯</summary>
            
            \`\`\`
            ${fs.readFileSync('reports/coverage.txt', 'utf8')}
            \`\`\`
            
            </details>
            `;
            
            // æŸ¥æ‰¾ç°æœ‰çš„è¦†ç›–ç‡è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š')
            );
            
            if (existingComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # æ„å»ºéªŒè¯
  build-check:
    name: ğŸ”¨ Build Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build ${{ matrix.service }}
        run: |
          echo "æ„å»º ${{ matrix.service }}..."
          cd webox/${{ matrix.service }}
          
          # ä¸‹è½½ä¾èµ–
          go mod download
          
          # æ„å»º
          if [ -f "Makefile" ]; then
            make build
          else
            go build -v ./...
          fi
          
          echo "âœ… ${{ matrix.service }} æ„å»ºæˆåŠŸ"

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Gosec Security Scanner
        uses: securecodewarrior/github-action-gosec@v1
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'
          
      - name: Upload Gosec scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif

  # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
  pr-check-summary:
    name: ğŸ“Š PR Check Summary
    runs-on: ubuntu-latest
    needs: [commit-message-check, pr-format-check, code-format-check, unit-tests, build-check, security-scan]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "=== PR æ£€æŸ¥ç»“æœæ±‡æ€» ==="
          
          # æ£€æŸ¥å„ä¸ªä½œä¸šçš„çŠ¶æ€
          commit_check="${{ needs.commit-message-check.result }}"
          pr_format="${{ needs.pr-format-check.result }}"
          code_format="${{ needs.code-format-check.result }}"
          unit_tests="${{ needs.unit-tests.result }}"
          build_check="${{ needs.build-check.result }}"
          security_scan="${{ needs.security-scan.result }}"
          
          echo "æäº¤æ¶ˆæ¯æ£€æŸ¥: $commit_check"
          echo "PR æ ¼å¼æ£€æŸ¥: $pr_format"
          echo "ä»£ç æ ¼å¼æ£€æŸ¥: $code_format"
          echo "å•å…ƒæµ‹è¯•: $unit_tests"
          echo "æ„å»ºæ£€æŸ¥: $build_check"
          echo "å®‰å…¨æ‰«æ: $security_scan"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„ä½œä¸š
          failed_jobs=()
          
          [ "$commit_check" = "failure" ] && failed_jobs+=("æäº¤æ¶ˆæ¯æ£€æŸ¥")
          [ "$pr_format" = "failure" ] && failed_jobs+=("PR æ ¼å¼æ£€æŸ¥")
          [ "$code_format" = "failure" ] && failed_jobs+=("ä»£ç æ ¼å¼æ£€æŸ¥")
          [ "$unit_tests" = "failure" ] && failed_jobs+=("å•å…ƒæµ‹è¯•")
          [ "$build_check" = "failure" ] && failed_jobs+=("æ„å»ºæ£€æŸ¥")
          [ "$security_scan" = "failure" ] && failed_jobs+=("å®‰å…¨æ‰«æ")
          
          if [ ${#failed_jobs[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ä»¥ä¸‹æ£€æŸ¥å¤±è´¥:"
            for job in "${failed_jobs[@]}"; do
              echo "  - $job"
            done
            echo ""
            echo "è¯·ä¿®å¤å¤±è´¥çš„æ£€æŸ¥é¡¹åé‡æ–°æäº¤"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰ PR æ£€æŸ¥é€šè¿‡ï¼"

      - name: Comment PR check summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            
            let summary = '## ğŸ“Š PR æ£€æŸ¥ç»“æœæ±‡æ€»\n\n';
            let allPassed = true;
            
            const jobs = [
              { name: 'æäº¤æ¶ˆæ¯æ£€æŸ¥', key: 'commit-message-check' },
              { name: 'PR æ ¼å¼æ£€æŸ¥', key: 'pr-format-check' },
              { name: 'ä»£ç æ ¼å¼æ£€æŸ¥', key: 'code-format-check' },
              { name: 'å•å…ƒæµ‹è¯•', key: 'unit-tests' },
              { name: 'æ„å»ºæ£€æŸ¥', key: 'build-check' },
              { name: 'å®‰å…¨æ‰«æ', key: 'security-scan' }
            ];
            
            for (const job of jobs) {
              const result = needs[job.key]?.result || 'skipped';
              let icon = 'âœ…';
              
              if (result === 'failure') {
                icon = 'âŒ';
                allPassed = false;
              } else if (result === 'cancelled') {
                icon = 'â¹ï¸';
              } else if (result === 'skipped') {
                icon = 'â­ï¸';
              }
              
              summary += `${icon} **${job.name}:** ${result}\n`;
            }
            
            summary += '\n';
            
            if (allPassed) {
              summary += 'ğŸ‰ **æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼** æ­¤ PR å¯ä»¥åˆå¹¶ã€‚';
            } else {
              summary += 'âš ï¸ **éƒ¨åˆ†æ£€æŸ¥å¤±è´¥** è¯·ä¿®å¤å¤±è´¥çš„æ£€æŸ¥é¡¹åé‡æ–°æäº¤ã€‚';
            }
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ±‡æ€»è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('PR æ£€æŸ¥ç»“æœæ±‡æ€»')
            );
            
            if (existingComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: summary
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }