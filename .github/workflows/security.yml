name: ğŸ”’ Security Scan

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
    paths:
      - 'go.mod'
      - 'go.sum'
      - '**/go.mod'
      - '**/go.sum'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dependencies
          - code
          - containers
          - secrets

env:
  GO_VERSION: '1.24.5'

jobs:
  # ä¾èµ–æ¼æ´æ‰«æ
  dependency-scan:
    name: ğŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'all' || inputs.scan_type == 'dependencies' || github.event_name == 'schedule' || github.event_name == 'push' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Install Nancy
        run: |
          go install github.com/sonatypecommunity/nancy@latest

      - name: Run Nancy vulnerability scan
        run: |
          echo "è¿è¡Œ Nancy ä¾èµ–æ¼æ´æ‰«æ..."
          mkdir -p reports

          # æ‰«æ api-service ä¾èµ–
          echo "æ‰«æ api-service ä¾èµ–..."
          cd webox/api-service
          go list -json -m all | nancy sleuth --output-format=json > ../../reports/nancy-api-service.json || true
          cd ../..

          # æ‰«æ websoft9-agent ä¾èµ–
          echo "æ‰«æ websoft9-agent ä¾èµ–..."
          cd webox/websoft9-agent
          go list -json -m all | nancy sleuth --output-format=json > ../../reports/nancy-agent.json || true
          cd ../..

          echo "Nancy æ‰«æå®Œæˆ"

      - name: Run Snyk vulnerability scan for api-service
        uses: snyk/actions/golang@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json-file-output=reports/snyk-api-service.json
          command: test
        continue-on-error: true
        if: env.SNYK_TOKEN != ''

      - name: Run Snyk vulnerability scan for websoft9-agent
        uses: snyk/actions/golang@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json-file-output=reports/snyk-agent.json
          command: test
        continue-on-error: true
        if: env.SNYK_TOKEN != ''

      - name: Process vulnerability results
        run: |
          echo "å¤„ç†æ¼æ´æ‰«æç»“æœ..."

          # åˆ›å»ºæ¼æ´æŠ¥å‘Š
          cat > reports/vulnerability-summary.md << 'EOF'
          # ğŸ”’ ä¾èµ–æ¼æ´æ‰«ææŠ¥å‘Š

          **æ‰«ææ—¶é—´:** $(date)
          **æ‰«æèŒƒå›´:** Go ä¾èµ–åŒ…

          ## ğŸ“Š æ‰«æç»“æœæ±‡æ€»

          EOF

          # å¤„ç† Nancy ç»“æœ
          if [ -f "reports/nancy-api-service.json" ]; then
            nancy_count=$(jq '.vulnerable | length' reports/nancy-api-service.json 2>/dev/null || echo "0")
            echo "- **API Service æ¼æ´æ•°é‡:** $nancy_count" >> reports/vulnerability-summary.md
          fi

          if [ -f "reports/nancy-agent.json" ]; then
            nancy_count=$(jq '.vulnerable | length' reports/nancy-agent.json 2>/dev/null || echo "0")
            echo "- **Agent æ¼æ´æ•°é‡:** $nancy_count" >> reports/vulnerability-summary.md
          fi

          # å¤„ç† Snyk ç»“æœ
          if [ -f "reports/snyk-results.json" ]; then
            snyk_count=$(jq '.vulnerabilities | length' reports/snyk-results.json 2>/dev/null || echo "0")
            echo "- **Snyk å‘ç°æ¼æ´æ•°é‡:** $snyk_count" >> reports/vulnerability-summary.md
          fi

          echo "" >> reports/vulnerability-summary.md
          echo "## ğŸ“‹ è¯¦ç»†ä¿¡æ¯" >> reports/vulnerability-summary.md
          echo "" >> reports/vulnerability-summary.md
          echo "è¯¦ç»†çš„æ¼æ´ä¿¡æ¯è¯·æŸ¥çœ‹ç›¸åº”çš„ JSON æŠ¥å‘Šæ–‡ä»¶ã€‚" >> reports/vulnerability-summary.md

      - name: Create security issues for high severity vulnerabilities
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // è¯»å– Nancy ç»“æœ
            const processNancyResults = (filePath, service) => {
              if (!fs.existsSync(filePath)) return [];

              try {
                const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                return (data.vulnerable || []).filter(vuln =>
                  vuln.cve && (vuln.cvssScore >= 7.0 || vuln.severity === 'HIGH' || vuln.severity === 'CRITICAL')
                ).map(vuln => ({
                  service,
                  type: 'dependency',
                  id: vuln.cve,
                  package: vuln.coordinates,
                  severity: vuln.severity || 'HIGH',
                  score: vuln.cvssScore,
                  description: vuln.title,
                  reference: vuln.reference
                }));
              } catch (e) {
                console.log(`Error processing ${filePath}:`, e.message);
                return [];
              }
            };

            // å¤„ç†æ¼æ´ç»“æœ
            const vulnerabilities = [
              ...processNancyResults('reports/nancy-api-service.json', 'api-service'),
              ...processNancyResults('reports/nancy-agent.json', 'websoft9-agent')
            ];

            console.log(`Found ${vulnerabilities.length} high severity vulnerabilities`);

            // ä¸ºé«˜å±æ¼æ´åˆ›å»º Issue
            for (const vuln of vulnerabilities) {
              const title = `[Security]: ${vuln.id} in ${vuln.package}`;
              const body = `## ğŸ”’ å®‰å…¨æ¼æ´æŠ¥å‘Š

              **æ¼æ´ ID:** ${vuln.id}
              **å½±å“æœåŠ¡:** ${vuln.service}
              **å½±å“åŒ…:** ${vuln.package}
              **ä¸¥é‡ç¨‹åº¦:** ${vuln.severity}
              **CVSS è¯„åˆ†:** ${vuln.score || 'N/A'}

              ### æè¿°
              ${vuln.description}

              ### å‚è€ƒé“¾æ¥
              ${vuln.reference || 'N/A'}

              ### å»ºè®®æªæ–½
              1. æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å®‰å…¨æ›´æ–°
              2. è¯„ä¼°æ¼æ´å¯¹ç³»ç»Ÿçš„å®é™…å½±å“
              3. åˆ¶å®šä¿®å¤è®¡åˆ’
              4. æ›´æ–°ä¾èµ–åŒ…åˆ°å®‰å…¨ç‰ˆæœ¬

              ---
              *æ­¤ Issue ç”±å®‰å…¨æ‰«æå·¥ä½œæµè‡ªåŠ¨åˆ›å»º*`;

              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ Issue
              const { data: existingIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'security,vulnerability',
                state: 'open'
              });

              const existingIssue = existingIssues.find(issue =>
                issue.title.includes(vuln.id) && issue.title.includes(vuln.package)
              );

              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['security', 'vulnerability', 'high-priority'],
                  assignees: []
                });

                console.log(`Created issue for vulnerability: ${vuln.id}`);
              } else {
                console.log(`Issue already exists for vulnerability: ${vuln.id}`);
              }
            }

      - name: Upload vulnerability reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-reports
          path: reports/
          retention-days: 30

  # ä»£ç å®‰å…¨æ‰«æ
  code-security-scan:
    name: ğŸ” Code Security Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'all' || inputs.scan_type == 'code' || github.event_name == 'schedule' || github.event_name == 'push' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            webox/api-service/go.sum
            webox/websoft9-agent/go.sum

      - name: Run Gosec Security Scanner for api-service
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: '-fmt sarif -out gosec-api-service.sarif webox/api-service/...'

      - name: Run Gosec Security Scanner for websoft9-agent
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: '-fmt sarif -out gosec-agent.sarif webox/websoft9-agent/...'

      - name: Upload Gosec scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-api-service.sarif

      - name: Upload Gosec scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-agent.sarif

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: go

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # å¯†é’¥æ³„éœ²æ£€æŸ¥
  secrets-scan:
    name: ğŸ” Secrets Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'all' || inputs.scan_type == 'secrets' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
  container-security-scan:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'all' || inputs.scan_type == 'containers' || github.event_name == 'schedule' }}
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: webox/${{ matrix.service }}
          file: webox/${{ matrix.service }}/Dockerfile
          tags: ${{ matrix.service }}:scan
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}-results.sarif'

      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@v3
        id: grype-scan
        with:
          image: ${{ matrix.service }}:scan
          fail-build: false
          output-format: sarif

      - name: Upload Grype scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: ${{ steps.grype-scan.outputs.sarif }}

  # å®‰å…¨é…ç½®æ£€æŸ¥
  security-config-check:
    name: âš™ï¸ Security Configuration Check
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'all' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security best practices
        run: |
          echo "æ£€æŸ¥å®‰å…¨é…ç½®æœ€ä½³å®è·µ..."
          mkdir -p reports

          # æ£€æŸ¥ Dockerfile å®‰å…¨é…ç½®
          echo "## ğŸ³ Dockerfile å®‰å…¨æ£€æŸ¥" > reports/security-config.md
          echo "" >> reports/security-config.md

          for dockerfile in $(find . -name "Dockerfile" -o -name "*.dockerfile"); do
            echo "æ£€æŸ¥ $dockerfile..."
            echo "### $dockerfile" >> reports/security-config.md
            echo "" >> reports/security-config.md

            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨é root ç”¨æˆ·
            if grep -q "USER" "$dockerfile"; then
              echo "âœ… ä½¿ç”¨é root ç”¨æˆ·" >> reports/security-config.md
            else
              echo "âš ï¸ å»ºè®®ä½¿ç”¨é root ç”¨æˆ·" >> reports/security-config.md
            fi

            # æ£€æŸ¥æ˜¯å¦å›ºå®šåŸºç¡€é•œåƒç‰ˆæœ¬
            if grep -E "FROM.*:latest" "$dockerfile"; then
              echo "âš ï¸ ä½¿ç”¨äº† latest æ ‡ç­¾ï¼Œå»ºè®®å›ºå®šç‰ˆæœ¬" >> reports/security-config.md
            else
              echo "âœ… ä½¿ç”¨å›ºå®šç‰ˆæœ¬çš„åŸºç¡€é•œåƒ" >> reports/security-config.md
            fi

            echo "" >> reports/security-config.md
          done

          # æ£€æŸ¥ GitHub Actions å®‰å…¨é…ç½®
          echo "## ğŸ”§ GitHub Actions å®‰å…¨æ£€æŸ¥" >> reports/security-config.md
          echo "" >> reports/security-config.md

          for workflow in .github/workflows/*.yml; do
            echo "æ£€æŸ¥ $workflow..."

            # æ£€æŸ¥æ˜¯å¦å›ºå®š action ç‰ˆæœ¬
            if grep -E "uses:.*@main|uses:.*@master" "$workflow"; then
              echo "âš ï¸ $workflow ä½¿ç”¨äº†ä¸å›ºå®šçš„ action ç‰ˆæœ¬" >> reports/security-config.md
            fi
          done

          echo "å®‰å…¨é…ç½®æ£€æŸ¥å®Œæˆ"

      - name: Upload security config report
        uses: actions/upload-artifact@v3
        with:
          name: security-config-report
          path: reports/security-config.md
          retention-days: 30

  # å®‰å…¨æ‰«ææ±‡æ€»
  security-summary:
    name: ğŸ“Š Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, secrets-scan, container-security-scan, security-config-check]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate security summary
        run: |
          echo "# ğŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Šæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰«ææ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“‹ æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰«æç±»å‹ | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¾èµ–æ¼æ´æ‰«æ | ${{ needs.dependency-scan.result }} | æ£€æŸ¥ Go ä¾èµ–åŒ…çš„å·²çŸ¥æ¼æ´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç å®‰å…¨æ‰«æ | ${{ needs.code-security-scan.result }} | é™æ€ä»£ç å®‰å…¨åˆ†æ |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯†é’¥æ³„éœ²æ£€æŸ¥ | ${{ needs.secrets-scan.result }} | æ£€æŸ¥ä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯æ³„éœ² |" >> $GITHUB_STEP_SUMMARY
          echo "| å®¹å™¨å®‰å…¨æ‰«æ | ${{ needs.container-security-scan.result }} | Docker é•œåƒæ¼æ´æ‰«æ |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨é…ç½®æ£€æŸ¥ | ${{ needs.security-config-check.result }} | å®‰å…¨é…ç½®æœ€ä½³å®è·µæ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ç¡®å®šæ•´ä½“å®‰å…¨çŠ¶æ€
          if [[ "${{ needs.dependency-scan.result }}" == "failure" || "${{ needs.code-security-scan.result }}" == "failure" || "${{ needs.secrets-scan.result }}" == "failure" ]]; then
            echo "## âŒ å‘ç°å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å®‰å…¨æ‰«æå‘ç°äº†éœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶åŠæ—¶ä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… å®‰å…¨æ‰«æé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å®‰å…¨æ‰«æéƒ½å·²é€šè¿‡ï¼Œæœªå‘ç°ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Security æ ‡ç­¾é¡µ](${{ github.server_url }}/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Send security notification
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const needs = ${{ toJSON(needs) }};

            // è®¡ç®—å¤±è´¥çš„æ‰«æ
            const failedScans = Object.entries(needs)
              .filter(([name, result]) => result.result === 'failure')
              .map(([name]) => name);

            if (failedScans.length > 0) {
              // å‘é€å®‰å…¨è­¦æŠ¥
              const title = 'ğŸš¨ å®‰å…¨æ‰«æå‘ç°é—®é¢˜';
              const body = `## å®‰å…¨æ‰«æè­¦æŠ¥

              **æ—¶é—´:** ${new Date().toISOString()}
              **ä»“åº“:** ${{ github.repository }}
              **åˆ†æ”¯:** ${{ github.ref_name }}

              **å¤±è´¥çš„æ‰«æ:**
              ${failedScans.map(scan => `- ${scan}`).join('\n')}

              è¯·åŠæ—¶æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤å‘ç°çš„å®‰å…¨é—®é¢˜ã€‚

              **æŸ¥çœ‹è¯¦æƒ…:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `;

              // åˆ›å»ºæˆ–æ›´æ–°å®‰å…¨ Issue
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'security,automated',
                state: 'open'
              });

              const existingIssue = issues.find(issue =>
                issue.title.includes('å®‰å…¨æ‰«æå‘ç°é—®é¢˜')
              );

              if (existingIssue) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: body
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['security', 'automated', 'high-priority']
                });
              }
            }