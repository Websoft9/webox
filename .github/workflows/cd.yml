name: ğŸš€ Continuous Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging
          - production
      force_deploy:
        description: 'Force deployment (skip checks)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  REGISTRY_NAMESPACE: websoft9

jobs:
  # éƒ¨ç½²å‰æ£€æŸ¥
  pre-deployment-check:
    name: ğŸ” Pre-deployment Check
    runs-on: ubuntu-latest
    outputs:
      deploy_environment: ${{ steps.determine-env.outputs.environment }}
      should_deploy: ${{ steps.check-conditions.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment environment
        id: determine-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=test" >> $GITHUB_OUTPUT
          fi

      - name: Check deployment conditions
        id: check-conditions
        run: |
          environment="${{ steps.determine-env.outputs.environment }}"
          force_deploy="${{ inputs.force_deploy }}"
          
          echo "éƒ¨ç½²ç¯å¢ƒ: $environment"
          echo "å¼ºåˆ¶éƒ¨ç½²: $force_deploy"
          
          # æ£€æŸ¥æ˜¯å¦åº”è¯¥éƒ¨ç½²
          should_deploy="true"
          
          if [ "$force_deploy" != "true" ]; then
            # æ£€æŸ¥æœ€è¿‘çš„ CI çŠ¶æ€
            echo "æ£€æŸ¥æœ€è¿‘çš„ CI çŠ¶æ€..."
            
            # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„æ£€æŸ¥é€»è¾‘
            # ä¾‹å¦‚ï¼šæ£€æŸ¥æœ€è¿‘çš„æµ‹è¯•ç»“æœã€å®‰å…¨æ‰«æç»“æœç­‰
          fi
          
          echo "should_deploy=$should_deploy" >> $GITHUB_OUTPUT

      - name: Validate deployment target
        run: |
          environment="${{ steps.determine-env.outputs.environment }}"
          
          case $environment in
            test)
              echo "âœ… éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
              ;;
            staging)
              echo "âœ… éƒ¨ç½²åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ"
              ;;
            production)
              echo "âœ… éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
              echo "âš ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦é¢å¤–å®¡æ‰¹"
              ;;
            *)
              echo "âŒ æ— æ•ˆçš„éƒ¨ç½²ç¯å¢ƒ: $environment"
              exit 1
              ;;
          esac

  # æ„å»ºéƒ¨ç½²é•œåƒ
  build-deployment-images:
    name: ğŸ”¨ Build Deployment Images
    runs-on: ubuntu-latest
    needs: [pre-deployment-check]
    if: needs.pre-deployment-check.outputs.should_deploy == 'true'
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
        include:
          - service: api-service
            context: webox/api-service
          - service: websoft9-agent
            context: webox/websoft9-agent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=deploy-${{ needs.pre-deployment-check.outputs.deploy_environment }}-{{sha}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-to-test:
    name: ğŸ§ª Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-deployment-images]
    if: needs.pre-deployment-check.outputs.deploy_environment == 'test'
    environment:
      name: ${{ needs.pre-deployment-check.outputs.deploy_environment }}
      url: https://test.websoft9.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up deployment configuration
        run: |
          echo "é…ç½®æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å‚æ•°..."
          
          # åˆ›å»ºéƒ¨ç½²é…ç½®
          mkdir -p deploy/test
          
          cat > deploy/test/docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            api-service:
              image: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/api-service:deploy-test-${{ github.sha }}
              ports:
                - "8080:8080"
                - "9090:9090"
              environment:
                - GIN_MODE=release
                - DB_TYPE=sqlite
                - DB_DSN=/app/data/websoft9.db
                - REDIS_URL=redis://redis:6379
                - JWT_SECRET=${{ secrets.TEST_JWT_SECRET }}
              depends_on:
                - redis
              restart: unless-stopped
              volumes:
                - api_data:/app/data
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
                interval: 30s
                timeout: 10s
                retries: 3
          
            websoft9-agent:
              image: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/websoft9-agent:deploy-test-${{ github.sha }}
              environment:
                - LOG_LEVEL=info
                - SERVER_URL=http://api-service:8080
                - AGENT_ID=test-agent-1
              depends_on:
                - api-service
              restart: unless-stopped
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
              privileged: true
          
            redis:
              image: redis:7.0
              ports:
                - "6379:6379"
              volumes:
                - redis_data:/data
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3
          
          volumes:
            api_data:
            redis_data:
          EOF

      - name: Deploy to test environment
        run: |
          echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
          
          # è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼šSSH åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼Œæ‹‰å–é•œåƒï¼Œæ›´æ–°æœåŠ¡ç­‰
          
          # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
          echo "1. åœæ­¢ç°æœ‰æœåŠ¡..."
          # docker-compose -f deploy/test/docker-compose.yml down
          
          echo "2. æ‹‰å–æœ€æ–°é•œåƒ..."
          # docker-compose -f deploy/test/docker-compose.yml pull
          
          echo "3. å¯åŠ¨æœåŠ¡..."
          # docker-compose -f deploy/test/docker-compose.yml up -d
          
          echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: Wait for services to be ready
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          
          # ç­‰å¾…æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
          max_attempts=30
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€... ($attempt/$max_attempts)"
            
            # è¿™é‡Œåº”è¯¥æ£€æŸ¥å®é™…çš„æœåŠ¡çŠ¶æ€
            # ä¾‹å¦‚ï¼šcurl å¥åº·æ£€æŸ¥ç«¯ç‚¹
            
            # æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥
            if [ $attempt -ge 5 ]; then
              echo "âœ… æ‰€æœ‰æœåŠ¡å·²å°±ç»ª"
              break
            fi
            
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
            exit 1
          fi

      - name: Run deployment verification tests
        run: |
          echo "è¿è¡Œéƒ¨ç½²éªŒè¯æµ‹è¯•..."
          
          # åŸºæœ¬è¿é€šæ€§æµ‹è¯•
          echo "1. API æœåŠ¡è¿é€šæ€§æµ‹è¯•..."
          # curl -f http://test.websoft9.com/health || exit 1
          
          echo "2. SQLite æ•°æ®åº“è¿æ¥æµ‹è¯•..."
          # æµ‹è¯• SQLite æ•°æ®åº“è¿æ¥
          
          echo "3. åŠŸèƒ½éªŒè¯æµ‹è¯•..."
          # è¿è¡Œå…³é”®åŠŸèƒ½çš„éªŒè¯æµ‹è¯•
          
          echo "âœ… éƒ¨ç½²éªŒè¯æµ‹è¯•é€šè¿‡"

  # éƒ¨ç½²åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ
  deploy-to-staging:
    name: ğŸ­ Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-deployment-images]
    if: needs.pre-deployment-check.outputs.deploy_environment == 'staging'
    environment:
      name: ${{ needs.pre-deployment-check.outputs.deploy_environment }}
      url: https://staging.websoft9.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging environment
        run: |
          echo "éƒ¨ç½²åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ..."
          
          # é¢„ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²é€»è¾‘
          # é€šå¸¸åŒ…æ‹¬æ›´ä¸¥æ ¼çš„éªŒè¯å’Œç›‘æ§
          
          echo "âœ… é¢„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: Run staging verification tests
        run: |
          echo "è¿è¡Œé¢„ç”Ÿäº§ç¯å¢ƒéªŒè¯æµ‹è¯•..."
          
          # æ›´å…¨é¢çš„éªŒè¯æµ‹è¯•
          echo "âœ… é¢„ç”Ÿäº§ç¯å¢ƒéªŒè¯æµ‹è¯•é€šè¿‡"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-to-production:
    name: ğŸŒŸ Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-deployment-images]
    if: needs.pre-deployment-check.outputs.deploy_environment == 'production'
    environment:
      name: ${{ needs.pre-deployment-check.outputs.deploy_environment }}
      url: https://websoft9.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment backup
        run: |
          echo "åˆ›å»ºéƒ¨ç½²å¤‡ä»½..."
          
          # å¤‡ä»½å½“å‰ç”Ÿäº§ç¯å¢ƒé…ç½®å’Œæ•°æ®
          backup_timestamp=$(date +%Y%m%d_%H%M%S)
          echo "backup_timestamp=$backup_timestamp" >> $GITHUB_ENV
          
          echo "âœ… å¤‡ä»½åˆ›å»ºå®Œæˆ: $backup_timestamp"

      - name: Deploy to production environment
        run: |
          echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          
          # ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²é€»è¾‘
          # åŒ…æ‹¬è“ç»¿éƒ¨ç½²ã€æ»šåŠ¨æ›´æ–°ç­‰ç­–ç•¥
          
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: Run production verification tests
        run: |
          echo "è¿è¡Œç”Ÿäº§ç¯å¢ƒéªŒè¯æµ‹è¯•..."
          
          # ç”Ÿäº§ç¯å¢ƒçš„éªŒè¯æµ‹è¯•
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯æµ‹è¯•é€šè¿‡"

      - name: Enable production traffic
        run: |
          echo "å¯ç”¨ç”Ÿäº§ç¯å¢ƒæµé‡..."
          
          # åˆ‡æ¢æµé‡åˆ°æ–°ç‰ˆæœ¬
          echo "âœ… ç”Ÿäº§ç¯å¢ƒæµé‡å·²å¯ç”¨"

  # éƒ¨ç½²åå¥åº·æ£€æŸ¥
  post-deployment-health-check:
    name: ğŸ¥ Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy-to-test, deploy-to-staging, deploy-to-production]
    if: always() && (needs.deploy-to-test.result == 'success' || needs.deploy-to-staging.result == 'success' || needs.deploy-to-production.result == 'success')
    steps:
      - name: Comprehensive health check
        run: |
          environment="${{ needs.pre-deployment-check.outputs.deploy_environment }}"
          
          echo "æ‰§è¡Œ $environment ç¯å¢ƒçš„å…¨é¢å¥åº·æ£€æŸ¥..."
          
          # è®¾ç½®ç¯å¢ƒ URL
          case $environment in
            test)
              base_url="https://test.websoft9.com"
              ;;
            staging)
              base_url="https://staging.websoft9.com"
              ;;
            production)
              base_url="https://websoft9.com"
              ;;
          esac
          
          echo "æ£€æŸ¥ URL: $base_url"
          
          # å¥åº·æ£€æŸ¥é¡¹ç›®
          checks=(
            "API æœåŠ¡çŠ¶æ€"
            "SQLite æ•°æ®åº“è¿æ¥"
            "Redis è¿æ¥"
            "å…³é”®åŠŸèƒ½éªŒè¯"
            "æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥"
          )
          
          failed_checks=()
          
          for check in "${checks[@]}"; do
            echo "æ‰§è¡Œæ£€æŸ¥: $check"
            
            # è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„å¥åº·æ£€æŸ¥é€»è¾‘
            # æ¨¡æ‹Ÿæ£€æŸ¥ç»“æœ
            if [ "$check" = "æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥" ] && [ "$environment" = "production" ]; then
              # æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒæ€§èƒ½æ£€æŸ¥å¯èƒ½å¤±è´¥
              if [ $((RANDOM % 10)) -lt 2 ]; then
                failed_checks+=("$check")
                echo "âŒ $check å¤±è´¥"
                continue
              fi
            fi
            
            echo "âœ… $check é€šè¿‡"
          done
          
          if [ ${#failed_checks[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ä»¥ä¸‹å¥åº·æ£€æŸ¥å¤±è´¥:"
            for check in "${failed_checks[@]}"; do
              echo "  - $check"
            done
            
            # è®¾ç½®è¾“å‡ºä»¥ä¾¿åç»­æ­¥éª¤å¤„ç†
            echo "health_check_failed=true" >> $GITHUB_ENV
            echo "failed_checks=${failed_checks[*]}" >> $GITHUB_ENV
          else
            echo ""
            echo "âœ… æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡"
            echo "health_check_failed=false" >> $GITHUB_ENV
          fi

      - name: Handle health check failures
        if: env.health_check_failed == 'true'
        run: |
          environment="${{ needs.pre-deployment-check.outputs.deploy_environment }}"
          
          echo "å¤„ç†å¥åº·æ£€æŸ¥å¤±è´¥..."
          
          if [ "$environment" = "production" ]; then
            echo "âš ï¸ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè€ƒè™‘å›æ»š"
            
            # è¿™é‡Œå¯ä»¥è§¦å‘è‡ªåŠ¨å›æ»šé€»è¾‘
            echo "è§¦å‘å›æ»šæµç¨‹..."
            
            # å‘é€ç´§æ€¥é€šçŸ¥
            echo "å‘é€ç´§æ€¥é€šçŸ¥..."
          else
            echo "âš ï¸ $environment ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
          fi

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy-to-test, deploy-to-staging, deploy-to-production, post-deployment-health-check]
    if: always()
    steps:
      - name: Determine deployment result
        id: result
        run: |
          environment="${{ needs.pre-deployment-check.outputs.deploy_environment }}"
          
          # ç¡®å®šéƒ¨ç½²ç»“æœ
          case $environment in
            test)
              deploy_result="${{ needs.deploy-to-test.result }}"
              ;;
            staging)
              deploy_result="${{ needs.deploy-to-staging.result }}"
              ;;
            production)
              deploy_result="${{ needs.deploy-to-production.result }}"
              ;;
          esac
          
          health_check_result="${{ needs.post-deployment-health-check.result }}"
          
          echo "environment=$environment" >> $GITHUB_OUTPUT
          echo "deploy_result=$deploy_result" >> $GITHUB_OUTPUT
          echo "health_check_result=$health_check_result" >> $GITHUB_OUTPUT
          
          # ç¡®å®šæ•´ä½“çŠ¶æ€
          if [ "$deploy_result" = "success" ] && [ "$health_check_result" = "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "status_message=éƒ¨ç½²æˆåŠŸ" >> $GITHUB_OUTPUT
          elif [ "$deploy_result" = "success" ] && [ "$health_check_result" = "failure" ]; then
            echo "overall_status=warning" >> $GITHUB_OUTPUT
            echo "status_message=éƒ¨ç½²æˆåŠŸä½†å¥åº·æ£€æŸ¥å¤±è´¥" >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_message=éƒ¨ç½²å¤±è´¥" >> $GITHUB_OUTPUT
          fi

      - name: Prepare email content
        id: email
        run: |
          status="${{ steps.result.outputs.overall_status }}"
          message="${{ steps.result.outputs.status_message }}"
          environment="${{ steps.result.outputs.environment }}"
          
          # è®¾ç½®é‚®ä»¶ä¸»é¢˜
          if [ "$status" = "success" ]; then
            subject="âœ… éƒ¨ç½²æˆåŠŸ - ${{ github.repository }} ($environment)"
          elif [ "$status" = "warning" ]; then
            subject="âš ï¸ éƒ¨ç½²è­¦å‘Š - ${{ github.repository }} ($environment)"
          else
            subject="âŒ éƒ¨ç½²å¤±è´¥ - ${{ github.repository }} ($environment)"
          fi
          
          echo "subject=$subject" >> $GITHUB_OUTPUT
          
          # è®¾ç½®ç¯å¢ƒ URL
          case $environment in
            test)
              env_url="https://test.websoft9.com"
              ;;
            staging)
              env_url="https://staging.websoft9.com"
              ;;
            production)
              env_url="https://websoft9.com"
              ;;
            *)
              env_url="N/A"
              ;;
          esac
          
          # ç”Ÿæˆé‚®ä»¶æ­£æ–‡
          cat > email_body.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <style>
                  body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                  .header { background-color: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                  .status-success { color: #28a745; }
                  .status-warning { color: #ffc107; }
                  .status-failure { color: #dc3545; }
                  .env-badge { 
                      display: inline-block; 
                      padding: 4px 8px; 
                      border-radius: 4px; 
                      font-size: 12px; 
                      font-weight: bold; 
                      text-transform: uppercase;
                  }
                  .env-test { background-color: #17a2b8; color: white; }
                  .env-staging { background-color: #ffc107; color: black; }
                  .env-production { background-color: #dc3545; color: white; }
                  .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                  .info-table th { background-color: #f2f2f2; }
                  .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h2>ğŸš€ éƒ¨ç½²æ‰§è¡ŒæŠ¥å‘Š</h2>
                  <p><strong>ä»“åº“:</strong> ${{ github.repository }}</p>
                  <p><strong>ç¯å¢ƒ:</strong> <span class="env-badge env-$environment">$environment</span></p>
                  <p><strong>çŠ¶æ€:</strong> <span class="status-$(echo $status | tr '[:upper:]' '[:lower:]')">$message</span></p>
              </div>
              
              <h3>ğŸ“‹ éƒ¨ç½²ä¿¡æ¯</h3>
              <table class="info-table">
                  <tr><th>ç›®æ ‡ç¯å¢ƒ</th><td>$environment</td></tr>
                  <tr><th>ç¯å¢ƒåœ°å€</th><td><a href="$env_url">$env_url</a></td></tr>
                  <tr><th>åˆ†æ”¯</th><td>${{ github.ref_name }}</td></tr>
                  <tr><th>æäº¤</th><td>${{ github.sha }}</td></tr>
                  <tr><th>éƒ¨ç½²è€…</th><td>${{ github.actor }}</td></tr>
                  <tr><th>æ‰§è¡Œæ—¶é—´</th><td>$(date)</td></tr>
              </table>
              
              <h3>ğŸ” æ‰§è¡Œç»“æœ</h3>
              <table class="info-table">
                  <tr><th>é˜¶æ®µ</th><th>çŠ¶æ€</th></tr>
                  <tr><td>éƒ¨ç½²å‰æ£€æŸ¥</td><td>success</td></tr>
                  <tr><td>é•œåƒæ„å»º</td><td>success</td></tr>
                  <tr><td>ç¯å¢ƒéƒ¨ç½²</td><td>${{ steps.result.outputs.deploy_result }}</td></tr>
                  <tr><td>å¥åº·æ£€æŸ¥</td><td>${{ steps.result.outputs.health_check_result }}</td></tr>
              </table>
              
              <h3>ğŸ”— ç›¸å…³é“¾æ¥</h3>
              <ul>
                  <li><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹å·¥ä½œæµè¿è¡Œè¯¦æƒ…</a></li>
                  <li><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}">æŸ¥çœ‹æäº¤è¯¦æƒ…</a></li>
                  <li><a href="$env_url">è®¿é—®éƒ¨ç½²ç¯å¢ƒ</a></li>
                  <li><a href="${{ github.server_url }}/${{ github.repository }}">è®¿é—®ä»“åº“</a></li>
              </ul>
              
              <div class="footer">
                  <p>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚</p>
                  <p>å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚</p>
              </div>
          </body>
          </html>
          EOF

      - name: Send email notification
        if: always() && vars.NOTIFICATION_EMAIL != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}
          server_port: ${{ vars.SMTP_PORT || '587' }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: ${{ vars.NOTIFICATION_EMAIL }}
          from: ${{ vars.FROM_EMAIL || secrets.SMTP_USERNAME }}
          html_body: file://email_body.html
          priority: ${{ steps.result.outputs.overall_status == 'failure' && 'high' || 'normal' }}

      - name: Create deployment record
        uses: actions/github-script@v6
        with:
          script: |
            const environment = '${{ steps.result.outputs.environment }}';
            const deployResult = '${{ steps.result.outputs.deploy_result }}';
            const healthCheckResult = '${{ steps.result.outputs.health_check_result }}';
            const overallStatus = '${{ steps.result.outputs.overall_status }}';
            
            // åˆ›å»ºéƒ¨ç½²è®°å½• Issue
            const title = `[Deployment] ${environment} - ${overallStatus} - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ğŸš€ éƒ¨ç½²è®°å½•
            
            **ç¯å¢ƒ:** ${environment}
            **çŠ¶æ€:** ${overallStatus}
            **æ—¶é—´:** ${new Date().toISOString()}
            **åˆ†æ”¯:** ${{ github.ref_name }}
            **æäº¤:** ${{ github.sha }}
            **éƒ¨ç½²è€…:** ${{ github.actor }}
            
            ### éƒ¨ç½²ç»“æœ
            - **éƒ¨ç½²çŠ¶æ€:** ${deployResult}
            - **å¥åº·æ£€æŸ¥:** ${healthCheckResult}
            
            ### ç›¸å…³é“¾æ¥
            - [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [æäº¤è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            
            ---
            *æ­¤è®°å½•ç”±éƒ¨ç½²å·¥ä½œæµè‡ªåŠ¨åˆ›å»º*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', environment, overallStatus]
            });

  # éƒ¨ç½²æ€»ç»“
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy-to-test, deploy-to-staging, deploy-to-production, post-deployment-health-check]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          environment="${{ needs.pre-deployment-check.outputs.deploy_environment }}"
          
          echo "# ğŸš€ éƒ¨ç½²æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡ç¯å¢ƒ:** $environment" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²è€…:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“‹ æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²å‰æ£€æŸ¥ | ${{ needs.pre-deployment-check.result }} |" >> $GITHUB_STEP_SUMMARY
          
          case $environment in
            test)
              echo "| æµ‹è¯•ç¯å¢ƒéƒ¨ç½² | ${{ needs.deploy-to-test.result }} |" >> $GITHUB_STEP_SUMMARY
              ;;
            staging)
              echo "| é¢„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² | ${{ needs.deploy-to-staging.result }} |" >> $GITHUB_STEP_SUMMARY
              ;;
            production)
              echo "| ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² | ${{ needs.deploy-to-production.result }} |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          
          echo "| éƒ¨ç½²åå¥åº·æ£€æŸ¥ | ${{ needs.post-deployment-health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç¡®å®šæ•´ä½“çŠ¶æ€å¹¶æ·»åŠ ç›¸åº”çš„æ€»ç»“
          if [[ "${{ needs.post-deployment-health-check.result }}" == "success" ]]; then
            echo "## âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° $environment ç¯å¢ƒï¼Œæ‰€æœ‰å¥åº·æ£€æŸ¥éƒ½å·²é€šè¿‡ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ éƒ¨ç½²å­˜åœ¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [æäº¤è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          
          case $environment in
            test)
              echo "- [æµ‹è¯•ç¯å¢ƒ](https://test.websoft9.com)" >> $GITHUB_STEP_SUMMARY
              ;;
            staging)
              echo "- [é¢„ç”Ÿäº§ç¯å¢ƒ](https://staging.websoft9.com)" >> $GITHUB_STEP_SUMMARY
              ;;
            production)
              echo "- [ç”Ÿäº§ç¯å¢ƒ](https://websoft9.com)" >> $GITHUB_STEP_SUMMARY
              ;;
          esac