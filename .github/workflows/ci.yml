name: ğŸš€ Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: '1.24.5'
  REGISTRY: docker.io
  REGISTRY_NAMESPACE: websoft9

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: webox/${{ matrix.service }}/go.sum

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: webox/${{ matrix.service }}
          args: --timeout=10m --out-format=github-actions

      - name: Run go vet
        working-directory: webox/${{ matrix.service }}
        run: |
          echo "è¿è¡Œ go vet æ£€æŸ¥..."
          go vet ./...

  # å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  tests:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
    services:
      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: webox/${{ matrix.service }}/go.sum

      - name: Wait for services
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          
          # ç­‰å¾… Redis
          for i in {1..30}; do
            if redis-cli -h 127.0.0.1 -p 6379 ping 2>/dev/null | grep -q PONG; then
              echo "Redis å·²å°±ç»ª"
              break
            fi
            echo "ç­‰å¾… Redis... ($i/30)"
            sleep 2
          done
          
          echo "æ‰€æœ‰æœåŠ¡å·²å°±ç»ª"

      - name: Initialize test database
        working-directory: webox
        run: |
          echo "åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“..."
          if [ -f "./scripts/init-test-db.sh" ]; then
            chmod +x ./scripts/init-test-db.sh
            ./scripts/init-test-db.sh --type sqlite --database ./test.db --seed
          else
            echo "æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
          fi

      - name: Run unit tests
        working-directory: webox/${{ matrix.service }}
        env:
          DB_TYPE: sqlite
          DB_DSN: "./test.db"
          REDIS_URL: "redis://127.0.0.1:6379"
        run: |
          echo "è¿è¡Œ ${{ matrix.service }} å•å…ƒæµ‹è¯•..."
          mkdir -p reports
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          go test -v -race -coverprofile=reports/coverage.out -covermode=atomic ./... | tee reports/test-results.txt
          
          # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          if [ -f "reports/coverage.out" ]; then
            go tool cover -html=reports/coverage.out -o reports/coverage.html
            go tool cover -func=reports/coverage.out > reports/coverage.txt
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ matrix.service }}
          path: webox/${{ matrix.service }}/reports/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: webox/${{ matrix.service }}/reports/coverage.out
          flags: ${{ matrix.service }}
          name: codecov-${{ matrix.service }}
          token: ${{ secrets.CODECOV_TOKEN }}

  # æ„å»ºæœåŠ¡
  build:
    name: ğŸ”¨ Build Services
    runs-on: ubuntu-latest
    needs: [code-quality]
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
        include:
          - service: api-service
            context: webox/api-service
            main_path: ./cmd/server
          - service: websoft9-agent
            context: webox/websoft9-agent
            main_path: ./cmd/agent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.context }}/go.sum

      - name: Build ${{ matrix.service }}
        working-directory: ${{ matrix.context }}
        run: |
          echo "æ„å»º ${{ matrix.service }}..."
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f "Makefile" ]; then
            make build
          else
            go build -v -o ${{ matrix.service }} ${{ matrix.main_path }}
          fi
          
          echo "âœ… ${{ matrix.service }} æ„å»ºæˆåŠŸ"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-binary
          path: ${{ matrix.context }}/${{ matrix.service }}
          retention-days: 7

  # Docker é•œåƒæ„å»º
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [build, tests]
    if: always() && (needs.build.result == 'success' && (needs.tests.result == 'success' || needs.tests.result == 'skipped'))
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
        include:
          - service: api-service
            dockerfile: webox/api-service/Dockerfile
            context: webox/api-service
          - service: websoft9-agent
            dockerfile: webox/websoft9-agent/Dockerfile
            context: webox/websoft9-agent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate SBOM
        if: github.ref == 'refs/heads/main'
        uses: anchore/sbom-action@v0.17.2
        with:
          image: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.service }}:latest
          format: spdx-json
          output-file: ${{ matrix.service }}-sbom.spdx.json

      - name: Upload SBOM
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-sbom
          path: ${{ matrix.service }}-sbom.spdx.json
          retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: always() && needs.docker-build.result == 'success'
    strategy:
      matrix:
        service: ['api-service', 'websoft9-agent']
        include:
          - service: api-service
            context: webox/api-service
          - service: websoft9-agent
            context: webox/websoft9-agent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.service }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}-results.sarif'
        continue-on-error: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}-results.sarif'
        continue-on-error: true

      - name: Set up Go for Gosec
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install and Run Gosec Security Scanner
        working-directory: ${{ matrix.context }}
        run: |
          echo "å®‰è£… Gosec..."
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          
          echo "è¿è¡Œ Gosec å®‰å…¨æ‰«æ..."
          # ä½¿ç”¨ || true ç¡®ä¿å³ä½¿å‘ç°å®‰å…¨é—®é¢˜ä¹Ÿä¸ä¼šå¤±è´¥
          $(go env GOPATH)/bin/gosec -fmt sarif -out ../gosec-${{ matrix.service }}-results.sarif ./... || true
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -f "../gosec-${{ matrix.service }}-results.sarif" ]; then
            echo "Gosec æ‰«ææœªç”Ÿæˆ SARIF æ–‡ä»¶ï¼Œåˆ›å»ºç©ºç»“æœæ–‡ä»¶"
            cat > ../gosec-${{ matrix.service }}-results.sarif << 'EOF'
          {
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "gosec",
                    "version": "latest"
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          fi
          
          echo "Gosec æ‰«æå®Œæˆ"

      - name: Upload Gosec scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'gosec-${{ matrix.service }}-results.sarif'
        continue-on-error: true

      - name: Generate security scan summary
        run: |
          echo "## ğŸ”’ å®‰å…¨æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ Trivy ç»“æœ
          if [ -f "trivy-${{ matrix.service }}-results.sarif" ]; then
            echo "âœ… Trivy å®¹å™¨å®‰å…¨æ‰«æå·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Trivy å®¹å™¨å®‰å…¨æ‰«ææœªå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ£€æŸ¥ Gosec ç»“æœ
          if [ -f "gosec-${{ matrix.service }}-results.sarif" ]; then
            echo "âœ… Gosec ä»£ç å®‰å…¨æ‰«æå·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Gosec ä»£ç å®‰å…¨æ‰«ææœªå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†çš„å®‰å…¨æ‰«æç»“æœè¯·æŸ¥çœ‹ GitHub Security æ ‡ç­¾é¡µã€‚" >> $GITHUB_STEP_SUMMARY

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run benchmark tests
        run: |
          echo "è¿è¡Œæ€§èƒ½æµ‹è¯•..."
          mkdir -p reports
          
          # è¿è¡ŒåŸºå‡†æµ‹è¯•
          go test -bench=. -benchmem -run=^$ ./... | tee reports/benchmark-results.txt
          
          # ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
          echo "## æ€§èƒ½æµ‹è¯•æŠ¥å‘Š" > reports/performance-report.md
          echo "" >> reports/performance-report.md
          echo "### åŸºå‡†æµ‹è¯•ç»“æœ" >> reports/performance-report.md
          echo "" >> reports/performance-report.md
          echo '```' >> reports/performance-report.md
          cat reports/benchmark-results.txt >> reports/performance-report.md
          echo '```' >> reports/performance-report.md

      - name: Upload performance reports
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: reports/
          retention-days: 30

  # é€šçŸ¥
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [code-quality, tests, build, docker-build, security-scan]
    if: always()
    steps:
      - name: Determine overall status
        id: status
        run: |
          code_quality="${{ needs.code-quality.result }}"
          tests="${{ needs.tests.result }}"
          build="${{ needs.build.result }}"
          docker_build="${{ needs.docker-build.result }}"
          security_scan="${{ needs.security-scan.result }}"
          
          echo "ä»£ç è´¨é‡æ£€æŸ¥: $code_quality"
          echo "æµ‹è¯•: $tests"
          echo "æ„å»º: $build"
          echo "Docker æ„å»º: $docker_build"
          echo "å®‰å…¨æ‰«æ: $security_scan"
          
          # ç¡®å®šæ•´ä½“çŠ¶æ€
          if [[ "$code_quality" == "failure" || "$build" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=CI æµæ°´çº¿å¤±è´¥" >> $GITHUB_OUTPUT
          elif [[ "$tests" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=æµ‹è¯•å¤±è´¥" >> $GITHUB_OUTPUT
          elif [[ "$docker_build" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Docker æ„å»ºå¤±è´¥" >> $GITHUB_OUTPUT
          elif [[ "$security_scan" == "failure" ]]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message=å®‰å…¨æ‰«æå‘ç°é—®é¢˜" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=CI æµæ°´çº¿æˆåŠŸ" >> $GITHUB_OUTPUT
          fi

      - name: Prepare email content
        id: email
        run: |
          status="${{ steps.status.outputs.status }}"
          message="${{ steps.status.outputs.message }}"
          
          # è®¾ç½®é‚®ä»¶ä¸»é¢˜
          if [ "$status" = "success" ]; then
            subject="âœ… CI æˆåŠŸ - ${{ github.repository }} (${{ github.ref_name }})"
          elif [ "$status" = "warning" ]; then
            subject="âš ï¸ CI è­¦å‘Š - ${{ github.repository }} (${{ github.ref_name }})"
          else
            subject="âŒ CI å¤±è´¥ - ${{ github.repository }} (${{ github.ref_name }})"
          fi
          
          echo "subject=$subject" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆé‚®ä»¶æ­£æ–‡
          cat > email_body.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <style>
                  body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                  .header { background-color: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                  .status-success { color: #28a745; }
                  .status-warning { color: #ffc107; }
                  .status-failure { color: #dc3545; }
                  .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                  .info-table th { background-color: #f2f2f2; }
                  .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h2>ğŸš€ CI æµæ°´çº¿æ‰§è¡ŒæŠ¥å‘Š</h2>
                  <p><strong>ä»“åº“:</strong> ${{ github.repository }}</p>
                  <p><strong>çŠ¶æ€:</strong> <span class="status-$(echo $status | tr '[:upper:]' '[:lower:]')">$message</span></p>
              </div>
              
              <h3>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
              <table class="info-table">
                  <tr><th>åˆ†æ”¯</th><td>${{ github.ref_name }}</td></tr>
                  <tr><th>æäº¤</th><td>${{ github.sha }}</td></tr>
                  <tr><th>ä½œè€…</th><td>${{ github.actor }}</td></tr>
                  <tr><th>è§¦å‘äº‹ä»¶</th><td>${{ github.event_name }}</td></tr>
                  <tr><th>æ‰§è¡Œæ—¶é—´</th><td>$(date)</td></tr>
              </table>
              
              <h3>ğŸ” æ‰§è¡Œç»“æœ</h3>
              <table class="info-table">
                  <tr><th>é˜¶æ®µ</th><th>çŠ¶æ€</th></tr>
                  <tr><td>ä»£ç è´¨é‡æ£€æŸ¥</td><td>${{ needs.code-quality.result }}</td></tr>
                  <tr><td>å•å…ƒæµ‹è¯•</td><td>${{ needs.tests.result }}</td></tr>
                  <tr><td>æœåŠ¡æ„å»º</td><td>${{ needs.build.result }}</td></tr>
                  <tr><td>Docker æ„å»º</td><td>${{ needs.docker-build.result }}</td></tr>
                  <tr><td>å®‰å…¨æ‰«æ</td><td>${{ needs.security-scan.result }}</td></tr>
              </table>
              
              <h3>ğŸ”— ç›¸å…³é“¾æ¥</h3>
              <ul>
                  <li><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹å·¥ä½œæµè¿è¡Œè¯¦æƒ…</a></li>
                  <li><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}">æŸ¥çœ‹æäº¤è¯¦æƒ…</a></li>
                  <li><a href="${{ github.server_url }}/${{ github.repository }}">è®¿é—®ä»“åº“</a></li>
              </ul>
              
              <div class="footer">
                  <p>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚</p>
                  <p>å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚</p>
              </div>
          </body>
          </html>
          EOF

      - name: Send email notification
        if: always() && vars.NOTIFICATION_EMAIL != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ vars.SMTP_SERVER || 'smtp.gmail.com' }}
          server_port: ${{ vars.SMTP_PORT || '587' }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: ${{ vars.NOTIFICATION_EMAIL }}
          from: ${{ vars.FROM_EMAIL || secrets.SMTP_USERNAME }}
          html_body: file://email_body.html
          priority: ${{ steps.status.outputs.status == 'failure' && 'high' || 'normal' }}

  # CI æ€»ç»“
  ci-summary:
    name: ğŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, tests, build, docker-build, security-scan, performance-test]
    if: always()
    steps:
      - name: Generate CI summary
        run: |
          echo "# ğŸš€ CI æµæ°´çº¿æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘è€…:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“‹ æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ | è€—æ—¶ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.code-quality.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•æ‰§è¡Œ | ${{ needs.tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡æ„å»º | ${{ needs.build.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker æ„å»º | ${{ needs.docker-build.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨æ‰«æ | ${{ needs.security-scan.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| æ€§èƒ½æµ‹è¯• | ${{ needs.performance-test.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç¡®å®šæ•´ä½“çŠ¶æ€
          if [[ "${{ needs.code-quality.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            echo "## âŒ æµæ°´çº¿å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å…³é”®é˜¶æ®µå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.tests.result }}" == "failure" ]]; then
            echo "## âš ï¸ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æµ‹è¯•é˜¶æ®µå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµ‹è¯•ç”¨ä¾‹å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… æµæ°´çº¿æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å…³é”®é˜¶æ®µéƒ½å·²æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [æäº¤è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "- [Docker é•œåƒ](https://hub.docker.com/r/${{ env.REGISTRY_NAMESPACE }})" >> $GITHUB_STEP_SUMMARY
          fi